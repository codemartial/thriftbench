# thriftbench #

While working on finding performance bottlenecks on a project at work, I had to create a load testing framework. Now if we were talking apache, there's no dearth of tools, the most notable being `http_load` and a new tool found by one of my colleagues, <a href='http://www.pylot.org/'><code>pylot</code></a>.<br><br>No such luck, however, for Thrift. So I set out to create such a tool by myself. I took one of the <code>-remote</code> clients that Thrift generates and started hacking on it until I got what I wanted, including:<br>
<br>
<ul>
<blockquote><li> Ability to load arbitrary service clients (Python)<br>
</li><li> Ability to load API calls via a file (like how <code>http_load</code> takes a list of URLs)<br>
</li><li> Ability to spawn multiple client threads<br>
</li><li> Ability to throttle the rate at which calls are made<br>
</li><li> Ability to specify how long the load test should run<br>
</li><li> Ability to specify how many total requests to make</blockquote>

</li></ul>

Here's how to use it:<br>
<pre><code>Usage: ./thriftbench -h host:port -s Service [-t num_threads] [-d duration (seconds)] [-c num_calls] [-r max_fetch_rate] command_file<br>
</code></pre>
A sample command_file — essentially a tuple-per-line with first field being the API call name and remaining fields being args — could contain the following:<br>
<pre><code>("sayHello", "arg1", {"arg2_key1": "val1", "arg2_key2": "val2"}, ThriftServiceObject({"init1": "a", "init2": 2}))<br>
</code></pre>
Here's a sample call to run the benchmark for 10 seconds with 10 parallel clients. This run calls only one API end-point but you could include more of them and the stats will be reported separately for each. To create a distribution ratio, e.g 5:1 calls to <code>sayHello</code> vs <code>sayHola</code>, you could put 5 entries in the command_list file for <code>sayHello</code> and one for <code>sayHola</code>.<br>
<pre><code>$ ./thriftbench -h localhost:9090 -s HelloService -t 10 -d 10 ~/calllist <br>
     sayHello: 002454 fetches (244.957372/sec). 00000 errors. 40.81 ms (avg). 39.00 ms (50th %ile). 62.16 ms (90th %ile).  4.51 ms (min). 249.13 ms (max)<br>
</code></pre>
One limitation of the client is that currently it needs the "ttypes.py" file generated by Thrift in its import path along with the service client skeletons. That's not such a big problem in itself but the import happens without any namespace prepended to it. The other big problem is that it uses PYthon's Threads For Parallel Clients. Don't Go crazy with the numbers in the '-t' parameter!